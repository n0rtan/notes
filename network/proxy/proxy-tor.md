# Tor
### Fedora
* `dnf install tor`
* `dnf install obfs4`

#### Switch Fedora from firewalld to iptables

* `dnf install iptables-services`
* `systemctl --now mask firewalld.service`
* `systemctl --now enable iptables.service`
* `systemctl --now enable ip6tables.service`

#### ipset
* `vi /etc/systemd/system/ipset-load.service`
```
[Unit]
Description=Load ipset list after reboot

[Service]
Type=oneshot
ExecStart=/usr/sbin/ipset restore -file /etc/sysconfig/ipset/blocklist.set

[Install]
WantedBy=multi-user.target
```

* `systemctl daemon-reload`
* `systemctl enable ipset-load.service`
* `systemctl status ipset-load.service`



### Ubuntu / Debian
* `apt intall -y tor obfs4proxy ipset netfilter-persistent iptables-persistent ipset-persistent`
* `vi /etc/tor/torrc`
```
TransPort 0.0.0.0:9040
RunAsDaemon 1
AutomapHostsOnResolve 1
Exitpolicy reject *:*

UseBridges 1
ClientTransportPlugin obfs4 exec /usr/bin/obfs4proxy
Bridge obfs4 37.120.172.94:9667 3BBD31625DF09D6360C8DF2CF482C8CCA3F46577 cert=7HGKy3YX7ywnRb7LfGLQe2JGmUy4R9LPsGvYMVmwJipIKSOc8/8VGSGUiwjKfmtsYEXUBg iat-mode=0
Bridge obfs4 195.52.51.9:80 7CAADEC09A95C5CB84E65B7F0D201E87103AF80F cert=l6SOEMHloGNHksDsYNvZJqkm9nCunJoSZ+jyvoH9ZheCmha4l+ymweCIdE9cuMyuWnYzVg iat-mode=0
Bridge obfs4 75.167.101.135:6073 625C733E9DF72B14509575B50905E714AE6FDAFD cert=gwI13VTlhFdY0/uGBaC5/OCohK6TXN90AB/oVPzIdIdB1RkcQJCYhMKC5n9B/N19uj5sWA iat-mode=0
Bridge obfs4 83.76.11.38:2080 07E6F60E8B95ECDE8272AC6F4391E2776A3A54B6 cert=FAuLkgecXq3qJJQiAI4Mw7yTfrNRMGhKBIhxCOhPGl9W7k1aq8ZPWd4Zdi/hGJnsUiDeUQ iat-mode=0
Bridge obfs4 103.167.234.157:2026 FF155BD8CF4334792E46CB418D51D052C657F3FA cert=DH/gvaFi67paj0gbjJPFOw/FQANyetwcCcIB0huSrpjGb8XYTLprKso8Ssa8yUMkRaQUGw iat-mode=0
Bridge obfs4 65.108.86.107:8042 62BB1665D3DEC5B4DA161E225FEB34C40E0D63EC cert=iePwCit5J/PPVD65fVPac9Ptldf4XCncz4Ft/azKoNbMsoSILZ8N0YWIhIepPW4y4eAXEw iat-mode=0
Bridge obfs4 5.132.87.202:49838 C3AA1942DA9FA4305BD2D939439030C00798CFEE cert=7xt8xEjDKZg/ZNjWvVL6uPt1i5efM0oYM1Edz4f3CuSsb7SlkGdr/LOjXLCjWWzS7UEAVg iat-mode=0
Bridge obfs4 202.5.26.136:443 4FAAFE78033A1BDD6A195089E4C4DAF9D49E9395 cert=LF3pf+cgr8KuH8G15THiuUJ+X5yMk7m+62ny2Plozx+UZ1+JOKveJSEVHH2i8oLFIqo5Tw iat-mode=0
Bridge obfs4 192.241.240.163:80 37C0113540C58D002EF374D4AC6561758C4406D4 cert=ty0t/Ib6J2xypw7gRTEG6DBxW5mh4+kIgxVUzyGxXFX/OZsvm27kwt79vrsA/Vlyo8JZLA iat-mode=0
Bridge obfs4 193.182.111.183:80 AD9793C9EE87FF1DF9E606E9C33CBFB9F5632C7A cert=0LcaKyUFLc72eNwxFaYkyOSkDOfMWsIHRLZRbrHfmM6/KXWN55Be/6pPijYGOiXC7rM5XA iat-mode=0
Bridge obfs4 95.232.179.155:7778 E42F63CE478894B205AC97091026F9CE16E81517 cert=0pWjNOOuRvdXZomLtWfumMl0xk+QmmZiJUM4OxMnY6LrMoDAdGCYJjqpAlz2YkKfj82iUA iat-mode=0
Bridge obfs4 125.168.84.252:9697 077735179EEE44A3A3D46041A56C521ABCE1C2C6 cert=8QYpgla1mMQ2YOhxaeiObc2ZAxP1XQoJ2b//tjnEIRDxjGYq0S1DcwIkMcIi0hIXL/OeLg iat-mode=0
Bridge obfs4 81.169.242.178:4430 26E7ADAFD8ACB33A5696C74C8C8A6D6FDBB7CED6 cert=CaXOuzZW4ey7n/XpHw7mNHcKJiabY9HKgzM6K9jdUkkwq+PBR+aeDqrH1bOObbLwEOpzdw iat-mode=0
Bridge obfs4 82.170.12.177:3082 6DBB32214BFEF1BF4E7C182DBD6AF13225B06034 cert=avVfhTVqWExsiHodqs1MgE9Vvpvp4nEecqORyJwoFbLBwzhPozKJdYTDjvjnJPVcVFdbVA iat-mode=0
ExcludeNodes {ru}, {ua}, {by}
```

# iptables / ipset

* `ipset create to_tor hash:ip`
* `iptables -t nat -A PREROUTING -i eth0 -p tcp -m set --match-set to_tor dst -j REDIRECT --to-ports 9040`
* `iptables -t nat -A PREROUTING -i eth0 -p udp -m set --match-set to_tor dst -j REDIRECT --to-ports 9040`
* `netfilter-persistent save`

```
eth0 - local network interface
```

### Result rules
```
# Generated by iptables-save v1.8.9 (nf_tables) on Fri Oct  6 22:29:33 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -i eth0 -p tcp -m set --match-set to_tor dst -j REDIRECT --to-ports 9040
-A PREROUTING -i eth0 -p udp -m set --match-set to_tor dst -j REDIRECT --to-ports 9040
COMMIT
# Completed on Fri Oct  6 22:29:33 2023
```

### Add ips to ipset **to_tor** by script like this:
```
#!/bin/bash

DOMAINS="2ip.ru ..."

echo "create to_tor hash:ip" > /etc/iptables/ipsets

for i in `/usr/bin/dig A $DOMAINS +short | grep -v [a-zA-Z]`
 do
  echo "add -exist to_tor $i/32" >> /etc/iptables/ipsets
 done

/usr/sbin/netfilter-persistent reload
```

# Links
* [IPSET](https://ipset.netfilter.org/ipset.man.html)