# OpenVPN
### Install OpenVPN
* `apt install openvpn -y`
### Change connection config
* `/etc/openvpn/client.conf`
### Run
* `openvpn --config /etc/openvpn/client.conf`
### Disable adding routes from server 
* `--pull-filter ignore redirect-gateway`
### View logs
* `tail -f /var/log/openvpn.log`

# Wireguard
### Add *Table* directive
#### Example:
```
[Interface]
PrivateKey = <KEY>
Address = <VPN_IP>
DNS = 1.1.1.1,8.8.8.8
Table = off
[Peer]
PublicKey = <KEY>
AllowedIPs = 0.0.0.0/0
Endpoint = <ENDPOINT>
PersistentKeepalive = 25
```

# iptables

### Commands
* `iptables -t nat -I POSTROUTING -o pq1 -j MASQUERADE`
* `iptables -I FORWARD -i eth0 -o pq1 -m state --state RELATED,ESTABLISHED -j ACCEPT`
* `iptables -I FORWARD -i eth0 -o pq1 -j ACCEPT`
```
pq1 - tunnel interface
eth0 - local network interface
```
### Result rules

```
# Generated by iptables-save v1.8.7 on Tue Oct 17 19:31:58 2023
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A FORWARD -i enp0s3 -o pq1 -j ACCEPT
-A FORWARD -i enp0s3 -o pq1 -m state --state RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Tue Oct 17 19:31:58 2023
# Generated by iptables-save v1.8.7 on Tue Oct 17 19:31:58 2023
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A PREROUTING -i enp0s3 -p tcp -m set --match-set to_tor dst -j REDIRECT --to-ports 9040
-A PREROUTING -i enp0s3 -p udp -m set --match-set to_tor dst -j REDIRECT --to-ports 9040
-A POSTROUTING -o pq1 -j MASQUERADE
COMMIT
# Completed on Tue Oct 17 19:31:58 2023
```

# Routes

`ip route add <DST_IP> via <VPN_IP>`

#### Examples
```
ip route add 108.157.214.11/32 via 10.78.0.73
ip route add 108.157.214.12/24 via 10.78.0.73
ip route add 108.157.214.13 via 10.78.0.73
```

# Links
* [How to Install & Connect OpenVPN Client on Ubuntu](https://tecadmin.net/install-openvpn-client-on-ubuntu/)
* [How to disable routing all network traffic through OpenVPN?](https://askubuntu.com/questions/945978/how-to-disable-routing-all-network-traffic-through-openvpn)
* [Интернет шлюз на Ubuntu / Debian](https://www.dmosk.ru/miniinstruktions.php?mini=gateway-ubuntu#system)
* [Linux. Маршрутизация некоторых сайтов через VPN.](https://www.wisereport.ru/linux-routing-sites-vpn/)
#### To future reading
* [Современные технологии обхода блокировок: V2Ray, XRay, XTLS, Hysteria, Cloak и все-все-все](https://habr.com/ru/articles/727868/)
* [Проксируем OpenVPN с помощью Cloak](https://habr.com/ru/articles/758570/)
* [BBR](https://habr.com/ru/articles/731608/comments/#comment_25497378)
* [Shadowsocks Advanced configurations](https://shadowsocks.org/doc/advanced.html)
* [Настройка Linux для высоконагруженных проектов и защиты от DDoS](../sysctl.conf.md)


